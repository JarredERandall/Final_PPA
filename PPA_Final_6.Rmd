---
title: "Fairbnb"
output: html_document
date: "2023-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE, class.source = 'fold-show'}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidycensus)
library(sf)
library(stargazer)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(kableExtra)
library(grid)
library(viridisLite)
library(viridis)
library(gridExtra)
library(jtools)
library(ggcorrplot) 
library(corrr)      
library(kableExtra)
library(jtools)     
library(ggstance) 
library(ggpubr)   
library(broom.mixed) 
options(scipen = 999)


root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

census_api_key("a6d692af505769f28e39a3ac16b7dcbacb1dad58", overwrite = TRUE)

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")

palette6 <- c("#25CB10", "#5AB60C", "grey40",   "grey40", "#FA7800")

theme_update(plot.title = element_text(hjust = 0.5))



```

# Intro

# Data
## Data Import
```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
listings <- read.csv("/Users/nohman/Documents/GitHub/PPA_Final_Airbnb/Data/Airbnb/listings.csv")

nhoods <- st_read("/Users/nohman/Documents/GitHub/PPA_Final_Airbnb/Data/Airbnb/neighbourhoods.geojson")

attraction_distance <- read.csv("/Users/nohman/Documents/GitHub/Final_PPA/Data/Airbnb/distance_attrac.csv")

listings_details <- read.csv("/Users/nohman/Documents/GitHub/PPA_Final_Airbnb/Data/Airbnb/listings_details.csv")

income <- read.csv("/Users/nohman/Documents/GitHub/Final_PPA/Data/Amsterdam_income.csv")
```

joined2 <- inner_join(joined, attraction_distance, by = "zipcode")

unique_nhoods <- as.data.frame(unique(joined$neighbourhood_cleansed))

join nhood to joined


## Data Wrangling
``` {r joined_nhood sf}
listings <- left_join(listings, listings_details, by = "id", suffix=c("", ".y")) %>% select(-ends_with(".y")) %>% st_as_sf(coords = c('longitude', 'latitude'), crs = 4326)  %>%
  st_transform(st_crs(nhoods))

listings <- st_join(listings, nhoods, join = st_within, suffix=c("", ".y")) %>% select(-ends_with(".y"))

#sf_income <- st_as_sf(income, coords = c("Longitude", "Latitude"), crs = 4326)%>%
#  st_transform(st_crs(listings))

#income_nhoods <- st_join(nhoods, sf_income) 
#income_nhoods$Average.income.per.income.recipient  <- as.numeric(income_nhoods$Average.income.per.income.recipient %>% str_extract("^.{2}"))
#View(income_nhoods)

#income_nhoods %>% group_by(neighbourhood) %>% select()



```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Adding the number of amenities per listing
amenities_count <- as.integer(str_count(listings$amenities, ","))
amenities_count <- ifelse(amenities_count > 0, amenities_count + 1, amenities_count)

listings <- cbind(listings, amenities_count) 

# Converting columns weekly price, monthly price, cleaning fee, and security deposit to numeric values
for (i in sequence(4, 67, 1)) {
  listings[[i]] <- gsub("^.{0,1}", "", listings[[i]])
  listings[[i]] <- as.numeric(ifelse(nchar(listings[[i]]) == 0, "0", listings[[i]]) %>% str_replace(",", ""))
}

# Calculating a daily price from either weekly or monthly price
listings$daily_price <- ifelse(listings$weekly_price > 0, joined$weekly_price / 7, listings$monthly_price / 30)

# Cleaning the zipcode by taking the first four numbers and removing whatever is after
listings$zipcode <- str_extract(listings$zipcode, "^.{4}")
  
listings <- listings %>% filter(daily_price > 0 & daily_price < 1500)

# Selecting a list of all relevant variables
var <- c("zipcode", "daily_price", "room_type", "host_is_superhost", "host_identity_verified", "accommodates", "beds", "bed_type", "cancellation_policy", "number_of_reviews", "property_type", "bathrooms", "bedrooms", "amenities_count", "review_scores_rating", "has_availability", "guests_included", "security_deposit", "cleaning_fee", "extra_people","neighbourhood", "availability_30")

listings <- listings %>% select(all_of(var))


# Removing NA values for important regression variables. Annotate how many we lost (Jarred)
listings <- listings %>% drop_na(cleaning_fee, security_deposit)






```

## Exploratory Data Analysis
```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Descriptive Statistics (Jarred) 
joined$daily_price <- log(joined$daily_price)
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Show a of the unlogged daily price (Jarred) 
joined$daily_price <- log(joined$daily_price)
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Log price by Property Type (Jarred) 
joined$daily_price <- log(joined$daily_price)
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Correlation Matrix (Jarred) 
joined$daily_price <- log(joined$daily_price)
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Log price by neighborhood (Jarred) 
joined$daily_price <- log(joined$daily_price)
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Log price by Room Type (Jarred) 
joined$daily_price <- log(joined$daily_price)
```





















```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Checking if we have too many categories in a variable
roomtype <- unique(joined$room_type)
length(roomtype)

property_type <- unique(joined$property_type)
length(property_type)

sum(is.na(joined$square_feet))

joined <- joined %>% mutate(extra_people_is_cost = ifelse(joined$extra_people %in% c("$0.00"), "No", "Yes"))


```


# Methods & Results


Regression Variables:

Spatial Features:
-nhood
-k nearest neighboors price per sqft

Non-Spatial (hedonic) Features:
- room type
- number of reviews
- availability
- is super host
- identity verified
- property type
- accomodates / guests_included?
- bathrooms
- bedrooms
- break up the amenities
- sqft is not there for all
- review_scores_rating
- costs extra?
- is real bed?
- cleaning fee
- cancellation policy 

# Training Regression

```{r regression, results = 'hide', fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE }
set.seed(100)

inTrain <- createDataPartition(
              y = paste(joined$daily_price,
                        joined$room_type,
                        joined$number_of_reviews),
              p = .60, list = FALSE)

joined_training <- joined[inTrain,] 

joined_test <- joined[-inTrain,] 


coords.test.training <-  st_coordinates(joined_training) 

neighborList.training <- knn2nb(knearneigh(coords.test.training, 10))

spatialWeights.training <- nb2listw(neighborList.training, style="W")


joined_training <- joined_training %>% mutate(k_nearest_price = lag.listw(spatialWeights.training, daily_price) / accommodates)


  reg_training <- 
    lm(daily_price ~ ., data = as.data.frame(joined_training) %>% 
                               dplyr::select(daily_price,
                                           room_type,
                                           k_nearest_price,
                                           number_of_reviews,
                                           property_type,
                                           bathrooms,
                                           bedrooms,
                                           review_scores_rating,
                                           cancellation_policy,
                                           host_identity_verified,
                                           accommodates,
                                           beds,
                                           bed_type,
                                           host_is_superhost,
                                           cleaning_fee,
                                           security_deposit,
                                           extra_people,
                                           zipcode,
                                           availability_30,
                                           neighbourhood.x))
  
summary(reg_training)$r.squared
```

# Training Regression Results

```{r result_traiining_set, fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}
joined_training <-
  joined_training %>%
  mutate(Regression = "Baseline Regression",
         daily_price.predict = exp(predict(reg_training, joined_training)),
         daily_price.error = daily_price.predict - exp(daily_price),
         daily_price.abserror = abs(daily_price.predict - exp(daily_price)),
         daily_price.ape = (abs(daily_price.predict - exp(daily_price))) / daily_price.predict)%>%
  filter(daily_price < 3000000, !is.na(daily_price.abserror))

results_train <- data.frame(MAE = mean(joined_training$sale_price.abserror, na.rm = T), MAPE =  mean(joined_training$sale_price.ape, na.rm = T))


results_train %>%
  kbl(caption = "Training Results") %>%
  kable_classic(full_width = F, html_font = "Cambria")

```

# Test Regression
```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}

coords.test.2 <-  st_coordinates(joined_test) 

neighborList.test.2 <- knn2nb(knearneigh(coords.test.2, 3))

spatialWeights.test.2 <- nb2listw(neighborList.test.2, style="W")

joined_test <- joined_test %>% mutate(k_nearest_price = lag.listw(spatialWeights.test.2, daily_price) / accommodates)

joined_test <-
  joined_test %>%
  mutate(Regression = "Baseline Regression",
         daily_price.predict = exp(predict(reg_training, joined_test)),
         daily_price.error = daily_price.predict - exp(daily_price),
         daily_price.abserror = abs(daily_price.predict - exp(daily_price)),
         daily_price.ape = (abs(daily_price.predict - exp(daily_price))) / daily_price.predict)%>%
  filter(daily_price < 3000000, !is.na(daily_price.abserror))


ggplot() +
  geom_sf(data = joined, fill ="grey40" ,colour = "white") +
  geom_sf(data = joined_test, aes(colour = q5(daily_price.error)),
          size = 1) +
  scale_colour_manual(values = palette6,
                      labels = qBr(joined_test, "daily_price.error"),
                      name = "Quintile \n Breaks")+
   labs(title = "daily_price Amsterdam") +
  mapTheme()
```


# Moran's I Test
```{r moran_mc, fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}

moranTest <- moran.mc(joined_test$daily_price.error, 
                      spatialWeights.test.2, nsim = 999)

morans_plot <-ggplot(as.data.frame(moranTest$res[c(1:999)]), aes(moranTest$res[c(1:999)])) +
  geom_histogram(binwidth = 0.01) +
  geom_vline(aes(xintercept = moranTest$statistic), colour = "#FA7800",size=1) +
  scale_x_continuous(limits = c(-1, 1)) +
  labs(title="Observed and permuted Moran's I",
       subtitle= "Observed Moran's I in orange",
       x="Moran's I",
       y="Count") +
  plotTheme()

morans_plot
```


## Cross-Validation
```{r result_cross_validation, results = 'hide', fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}
fitControl <- trainControl(method = "cv", number = 100)
set.seed(825)

reg.cv <- 
  train(sale_price ~ ., data = st_drop_geometry(philly.training) %>% 
                               dplyr::select(sale_price, 
                                             k_nearest_price,
                                             pctWhite.2020,
                                             pctGrad.2020,
                                             med_HH_Income.2020,  
                                             total_livable_area,
                                             frontage, 
                                             exterior_condition,
                                             interior_condition,
                                             number_of_bathrooms,
                                             quality_grade,
                                             basements,
                                             garage_spaces,
                                             sewer, separate_utilities,
                                             street_designation,
                                             building_code_description_new, 
                                             view_type, 
                                             general_construction, 
                                             stories, 
                                             number_of_bedrooms), 
     method = "lm", trControl = fitControl, na.action = na.pass)

reg.cv$resample[1:100,]




```



```{r result_cross_validation_graph, fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}
ggplot(reg.cv$resample) +
  aes(MAE) +
  geom_histogram(bins=15)
```









- explain why we only did a count on ameniities (because they range to very smimilar objects)
- justify why we predict daily price with weekly (monthly usually has discount, most people book for fewer days. Prove this with data)


medhh income
pct education
pct immigrants
marital status
year built
Profession
distance to tourist attractions



Check instances for each variable



Questions for Michael:
1. Wants to see process of varibale choice (i.e. we run regression and then drop variables etc?)
2. Is our idea valid?
3. How does regression handle NA




```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
#JArred
listings <- read.csv("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\listings.csv")

listings_details <- read.csv("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\listings_details.csv")

nhoods <- st_read("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\neighbourhoods.geojson")

joined <- left_join(listings, listings_details, by = "id", suffix=c("", ".y")) %>% select(-ends_with(".y"))

```



```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
#JArred
listings <- read.csv("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\listings.csv")

listings_details <- read.csv("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\listings_details.csv")

nhoods <- st_read("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\neighbourhoods.geojson")

joined <- left_join(listings, listings_details, by = "id", suffix=c("", ".y")) %>% select(-ends_with(".y"))

attraction_distance <- read.csv("C:\\Users\\fatbo\\OneDrive\\Documents\\GitHub\\Final_PPA\\Data\\Airbnb\\distance_attrac.csv")

income <- read.csv("C:\\Users\\fatbo\\OneDrive\\Documents\\GitHub\\Final_PPA\\Data\\Amsterdam_income.csv")

```