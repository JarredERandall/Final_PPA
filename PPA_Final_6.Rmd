---
title: "FairBnB"
output: html_document
date: "2023-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE, class.source = 'fold-show'}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidycensus)
library(sf)
library(stargazer)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(kableExtra)
library(grid)
library(viridisLite)
library(viridis)
library(gridExtra)
library(jtools)
library(ggcorrplot) 
library(corrr)      
library(kableExtra)
library(jtools)     
library(ggstance) 
library(ggpubr)   
library(broom.mixed) 
options(scipen = 999)


root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

census_api_key("a6d692af505769f28e39a3ac16b7dcbacb1dad58", overwrite = TRUE)

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")

palette6 <- c("#25CB10", "#5AB60C", "grey40",   "grey40", "#FA7800")

theme_update(plot.title = element_text(hjust = 0.5))



```

# Intro

# Data
## Data Import
```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
listings <- read.csv("/Users/nohman/Documents/GitHub/PPA_Final_Airbnb/Data/Airbnb/listings.csv")

nhoods <- st_read("/Users/nohman/Documents/GitHub/PPA_Final_Airbnb/Data/Airbnb/neighbourhoods.geojson")

attraction_distance <- read.csv("/Users/nohman/Documents/GitHub/Final_PPA/Data/Airbnb/distance_attrac.csv")

listings_details <- read.csv("/Users/nohman/Documents/GitHub/PPA_Final_Airbnb/Data/Airbnb/listings_details.csv")

income <- read.csv("/Users/nohman/Documents/GitHub/Final_PPA/Data/Amsterdam_income.csv")
```

joined2 <- inner_join(joined, attraction_distance, by = "zipcode")

unique_nhoods <- as.data.frame(unique(joined$neighbourhood_cleansed))

join nhood to joined


## Data Wrangling
``` {r joined_nhood sf}
attraction_distance <- attraction_distance %>% transform(zipcode = as.character(zipcode))

listings <- left_join(listings, listings_details, by = "id", suffix=c("", ".y")) %>% select(-ends_with(".y"))

listings <- left_join(listings, attraction_distance, by = "zipcode", suffix=c("", ".y")) %>% select(-ends_with(".y")) %>% st_as_sf(coords = c('longitude', 'latitude'), crs = 4326)  %>%
  st_transform(st_crs(nhoods))

listings <- st_join(listings, nhoods, join = st_within, suffix=c("", ".y")) %>% select(-ends_with(".y"))
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Adding the number of amenities per listing
amenities_count <- as.integer(str_count(listings$amenities, ","))
amenities_count <- ifelse(amenities_count > 0, amenities_count + 1, amenities_count)

listings <- cbind(listings, amenities_count) 

# Converting columns weekly price, monthly price, cleaning fee, and security deposit to numeric values
for (i in sequence(4, 67, 1)) {
  listings[[i]] <- gsub("^.{0,1}", "", listings[[i]])
  listings[[i]] <- as.numeric(ifelse(nchar(listings[[i]]) == 0, "0", listings[[i]]) %>% str_replace(",", ""))
}

# Remove rows with no rent data
listings <- listings %>% filter(weekly_price > 0 | monthly_price > 0)

# Calculating a daily price from either weekly or monthly price
listings$daily_price <- ifelse(listings$weekly_price > 0, listings$weekly_price / 7, listings$monthly_price / 30)

# Cleaning the zipcode by taking the first four numbers and removing whatever is after
listings$zipcode <- str_extract(listings$zipcode, "^.{4}")
  
listings <- listings %>% filter(daily_price > 0 & daily_price < 1500)

# Selecting a list of all relevant variables
var <- c("zipcode", "daily_price", "room_type", "host_is_superhost", "host_identity_verified", "accommodates", "beds", "bed_type", "cancellation_policy", "number_of_reviews", "property_type", "bathrooms", "bedrooms", "amenities_count", "review_scores_rating", "has_availability", "guests_included", "security_deposit", "cleaning_fee", "extra_people","neighbourhood", "availability_30", "weekly_price", "monthly_price", "near_ATTRAC", "near_museum", "near_Performing_arts")

listings <- listings %>% select(all_of(var)) 


# Removing NA values for important regression variables. Annotate how many we lost (Jarred)
listings <- listings %>% drop_na(cleaning_fee, security_deposit)
```

## Exploratory Data Analysis
```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Descriptive Statistics (Jarred) 

# Descriptive Statistics (Jarred) 



install.packages("summarytools")
library(summarytools)

#"k_nearest_price"????

variables_to_summarize <- c("daily_price","near_ATTRAC", "property_type", "beds", "accommodates", "bed_type",                             "bathrooms", "bedrooms", "amenities_count", "review_scores_rating",
                            "number_of_reviews", "cancellation_policy",
                            "host_identity_verified", "bed_type", "host_is_superhost", 
                            "cleaning_fee", "security_deposit", "extra_people",
                            "zipcode","neighbourhood", "availability_30", "near_museum",
                            "near_Performing_arts")




summary_stats <- descr(listings[, variables_to_summarize], stats = "common")  
summary_table <- t(summary_stats)


rounded_summary <- t(apply(summary_table, 1, function(x) {
  if (all(is.numeric(x))) {
    return(round(x, 2))
  } else {
    return(x)
  }
}))

# Create the table using kableExtra
rounded_summary %>%
  kbl(caption = "Summary Statistics") %>%
  kable_classic(full_width = F, html_font = "Cambria")
 

```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Show a of the unlogged daily price (Jarred) 

ggplot(listings, aes(x=daily_price)) + 
    geom_histogram(fill="darkblue") +
    ggtitle("Airbnb Daily Price Distribution") 
```

```{r daily_price_map, fig.height=8, fig.width=8}


ggplot() +
  geom_sf(data = nhoods, fill = "grey90") +
  geom_sf(data = listings, aes(colour = daily_price), show.legend = "point", size = 0.75) +
  scale_color_viridis_b(
    limits = c(0, 600),  # Set the color scale limits (adjust as needed)
    breaks = c(0, 50, 100, 150, 200, 250,300,350),  # Specify break points
    labels = c("0", "50", "100", "150", "200", "250","300","350+"),  # Specify labels
    name = "Daily Price"  # Set the legend title
  ) +
  labs(title = "Amsterdam Daily Airbnb Price Home") +
  theme_void() +
  theme(
    legend.title = element_text(margin = margin(b = 10))  # Adjust the bottom margin of the legend title
  )

```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Log price by Property Type (Jarred) 
listings$daily_price <- log(listings$daily_price)

ggplot(listings, aes(x=daily_price)) + 
    geom_histogram(fill="darkblue") +
    ggtitle("Log of Daily Price Distribution") 

```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Correlation Matrix (Jarred) 

variables_to_summarize <- 
  select_if(st_drop_geometry(listings), is.numeric) %>% na.omit()

variables_to_summarize <- select_if(st_drop_geometry(listings), is.numeric) %>%
  na.omit()


ggcorrplot(
  round(cor(variables_to_summarize), 1), 
  p.mat = cor_pmat(variables_to_summarize),
  colors = c("#25CB10", "white", "#FA7800"),
  type="lower",
  insig = "blank") +  
    labs(title = "Correlation across numeric variables") 
```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE, fig.width=8, fig.height=8}
# Log price by neighborhood (Jarred) 
listings$neighbourhood <- factor(listings$neighbourhood)




colors <- rainbow(length(unique(listings$neighbourhood)))
faded_colors <- adjustcolor(colors, alpha.f = 0.4) 

ggplot(data = listings, aes(x = neighbourhood, y = log(daily_price), fill = neighbourhood)) + 
  geom_boxplot() +
  scale_fill_manual(values = faded_colors, name = "Neighborhoods") + 
  theme_minimal() +
  labs(y = "Logarithm of Price", x = "", title = "Logarithm of Daily Price by Neighborhood.") +
  theme(
    axis.text.x = element_blank(), 
    legend.position = "bottom", 
    legend.title.align = 0.5, 
    plot.title = element_text(hjust = 0.5) 
  ) +
  guides(fill = guide_legend(nrow = 5, byrow = TRUE, title.position = "top")) 

```

```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Log price by Room Type (Jarred) 

faded_colors2 <- adjustcolor(colors, alpha.f = 0.6) 

ggplot(data = listings, aes(x = room_type, y = log(daily_price), fill = room_type)) + 
  geom_boxplot() +
  scale_fill_manual(values = faded_colors2, name = "Listing Type") + 
  theme_minimal() +
  labs(y = "Logarithm of Price", x = "", title = "Logarithm of Daily Price by Listing Type") +
  theme(
    axis.text.x = element_blank(), 
    legend.position = "bottom", 
    legend.title.align = 0.5, 
    plot.title = element_text(hjust = 0.5) 
  ) +
  guides(fill = guide_legend(nrow =1, byrow = TRUE, title.position = "top")) 

```



```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
# Checking if we have too many categories in a variable

roomtype <- unique(listings$room_type)
length(roomtype)

property_type <- unique(listings$property_type)
length(property_type)

property_type <- unique(listings$property_type)
length(property_type)

sum(is.na(joined$square_feet))

joined <- joined %>% mutate(extra_people_is_cost = ifelse(joined$extra_people %in% c("$0.00"), "No", "Yes"))



variables_to_summarize <- c("room_type", "daily_price", "beds", "accommodates", "bed_type",
                            "bathrooms", "bedrooms", "amenities_count", "review_scores_rating")


unique_values_df <- data.frame(Variable = character(), Unique_Values = integer(), stringsAsFactors = FALSE)


for (var in variables_to_summarize) {
  unique_values_df <- rbind(unique_values_df, data.frame(Variable = var, Unique_Values = length(unique(listings[[var]]))))
}


unique_values_df %>%
  kbl(caption = "Variable Values") %>%
  kable_classic(full_width = F, html_font = "Cambria")


```

```{r map_1}
avg_price_by_neighbourhood <- listings %>%
  group_by(neighbourhood) %>%
  summarize(average_price = mean(daily_price, na.rm = TRUE))

neighbourhood_boundaries <- nhoods

neighbourhood_boundaries$neighbourhood <- as.character(neighbourhood_boundaries$neighbourhood)
avg_price_by_neighbourhood$neighbourhood <- as.character(avg_price_by_neighbourhood$neighbourhood)


merged_data_sf <- st_join(neighbourhood_boundaries, avg_price_by_neighbourhood)


scales::show_col(c("#9DBF9E", "#A84268", "#FCB97D", "#C0BCB5", "#4A6C6F", "#FF5E5B"))
color

merged_data_sf %>% 
  ggplot() +
  geom_sf(
    aes(fill = average_price), 
    lwd = 0,
    colour = "white") +
  scale_fill_gradientn(
    colors = c("#9DBF9E", "#FCB97D", "#A84268"),
    na.value = "grey80",
    oob = scales::squish,
    labels = scales::label_comma(),  # You can use different label formatting functions here
    name = "Active STRs as share of total dwellings") +
  # Set a completely blank theme, to get rid of all background and axis elements
  theme_void()
 
pal2 <- c("#9DBF9E", "#A84268", "#FCB97D", "#C0BCB5", "#4A6C6F", "#FF5E5B")

ggplot() +
  geom_sf(data = merged_data_sf, aes(fill = average_price), color = NA) +
  scale_fill_gradient(low = "white",high = "darkred") +
  labs(title = "Average Daily Price by Neighborhood") +
  theme( 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    )

listings$daily_price <- as.numeric(as.character(listings$daily_price))

# Create your ggplot2 plot with a continuous color scale
ggplot() +
  geom_sf(data = nhoods, fill = "grey90") +
  geom_sf(data = listings, aes(colour = daily_price), show.legend = "point", size = 0.75) +
  scale_color_viridis_b(
    limits = c(2, 8),  # Set the color scale limits (adjust as needed)
    breaks = c(3, 4, 5, 6, 7),  # Specify break points
    labels = c("3", "4", "5", "6", "7"),  # Specify labels
    name = "Daily Price"  # Set the legend title
  ) +
  labs(title = "Amsterdam Logged Daily Airbnb Price Home") +
  theme_void() +
  theme(
    legend.title = element_text(margin = margin(b = 10))  # Adjust the bottom margin of the legend title
  )

hist((listings$daily_price))

```


hist(listings$daily_price)
# Methods & Results


Regression Variables:

Spatial Features:
-nhood
-k nearest neighboors price per sqft

Non-Spatial (hedonic) Features:
- room type
- number of reviews
- availability
- is super host
- identity verified
- property type
- accomodates / guests_included?
- bathrooms
- bedrooms
- break up the amenities
- sqft is not there for all
- review_scores_rating
- costs extra?
- is real bed?
- cleaning fee
- cancellation policy 

# Training Regression

```{r regression, results = 'hide', fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE }

inTrain <- createDataPartition(
              y = paste(listings$daily_price),
              p = .6, list = FALSE)

listings_train <- listings[inTrain,] 

listings_test <- listings[-inTrain,] 

nrow(listings_test)


coords.test.training <-  st_coordinates(listings_train) 

neighborList.training <- knn2nb(knearneigh(coords.test.training, 5))

spatialWeights.training <- nb2listw(neighborList.training, style="W")


listings_train <- listings_train %>% mutate(k_nearest_price = lag.listw(spatialWeights.training, daily_price) / accommodates)


  reg_train <- 
    lm(daily_price ~ ., data = as.data.frame(listings_train) %>% 
                               dplyr::select(daily_price,
                                           room_type,
                                           near_ATTRAC,
                                           k_nearest_price,
                                           number_of_reviews,
                                           property_type,
                                           bathrooms,
                                           bedrooms,
                                           review_scores_rating,
                                           cancellation_policy,
                                           host_identity_verified,
                                           accommodates,
                                           beds,
                                           bed_type,
                                           host_is_superhost,
                                           cleaning_fee,
                                           security_deposit,
                                           extra_people,
                                           zipcode,
                                           availability_30,
                                           neighbourhood))
  
summary(reg_train)$r.squared
```

# Training Regression Results

```{r result_traiining_set, fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}
listings_train <-
  listings_train %>%
  mutate(Regression = "Baseline Regression",
         daily_price.predict = exp(predict(reg_train, listings_train)),
         daily_price.error = daily_price.predict - exp(daily_price),
         daily_price.abserror = abs(daily_price.predict - exp(daily_price)),
         daily_price.ape = (abs(daily_price.predict - exp(daily_price))) / daily_price.predict)%>%
  filter(!is.na(daily_price.abserror))


results_train <- data.frame(MAE = mean(listings_train$daily_price.abserror, na.rm = T), MAPE =  mean(listings_train$daily_price.ape, na.rm = T))


results_train %>%
  kbl(caption = "Training Results") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

# Test Regression
```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}

coords.test.2 <-  st_coordinates(listings_test) 

neighborList.test.2 <- knn2nb(knearneigh(coords.test.2, 3))

spatialWeights.test.2 <- nb2listw(neighborList.test.2, style="W")

listings_test <- listings_test %>% mutate(k_nearest_price = lag.listw(spatialWeights.test.2, daily_price) / accommodates)

listings_test <-
  listings_test %>%
  mutate(Regression = "Baseline Regression",
         daily_price.predict = exp(predict(reg_train, listings_test)),
         daily_price.error = daily_price.predict - exp(daily_price),
         daily_price.abserror = abs(daily_price.predict - exp(daily_price)),
         daily_price.ape = (abs(daily_price.predict - exp(daily_price))) / daily_price.predict)%>%
  filter(daily_price < 3000000, !is.na(daily_price.abserror))


ggplot() +
  geom_sf(data = joined, fill ="grey40" ,colour = "white") +
  geom_sf(data = joined_test, aes(colour = q5(daily_price.error)),
          size = 1) +
  scale_colour_manual(values = palette6,
                      labels = qBr(joined_test, "daily_price.error"),
                      name = "Quintile \n Breaks")+
   labs(title = "daily_price Amsterdam") +
  mapTheme()
```


# Moran's I Test
```{r moran_mc, fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}

moranTest <- moran.mc(joined_test$daily_price.error, 
                      spatialWeights.test.2, nsim = 999)

morans_plot <-ggplot(as.data.frame(moranTest$res[c(1:999)]), aes(moranTest$res[c(1:999)])) +
  geom_histogram(binwidth = 0.01) +
  geom_vline(aes(xintercept = moranTest$statistic), colour = "#FA7800",size=1) +
  scale_x_continuous(limits = c(-1, 1)) +
  labs(title="Observed and permuted Moran's I",
       subtitle= "Observed Moran's I in orange",
       x="Moran's I",
       y="Count") +
  plotTheme()

morans_plot
```


## Cross-Validation
```{r result_cross_validation, results = 'hide', fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}
fitControl <- trainControl(method = "cv", number = 100)
set.seed(825)

reg.cv <- 
  train(sale_price ~ ., data = st_drop_geometry(philly.training) %>% 
                               dplyr::select(sale_price, 
                                             k_nearest_price,
                                             pctWhite.2020,
                                             pctGrad.2020,
                                             med_HH_Income.2020,  
                                             total_livable_area,
                                             frontage, 
                                             exterior_condition,
                                             interior_condition,
                                             number_of_bathrooms,
                                             quality_grade,
                                             basements,
                                             garage_spaces,
                                             sewer, separate_utilities,
                                             street_designation,
                                             building_code_description_new, 
                                             view_type, 
                                             general_construction, 
                                             stories, 
                                             number_of_bedrooms), 
     method = "lm", trControl = fitControl, na.action = na.pass)

reg.cv$resample[1:100,]




```



```{r result_cross_validation_graph, fig.align= 'center', warning = FALSE, message = FALSE, error = FALSE}
ggplot(reg.cv$resample) +
  aes(MAE) +
  geom_histogram(bins=15)
```









- explain why we only did a count on ameniities (because they range to very smimilar objects)
- justify why we predict daily price with weekly (monthly usually has discount, most people book for fewer days. Prove this with data)


medhh income
pct education
pct immigrants
marital status
year built
Profession
distance to tourist attractions



Check instances for each variable



Questions for Michael:
1. Wants to see process of varibale choice (i.e. we run regression and then drop variables etc?)
2. Is our idea valid?



```{r read_data, results = FALSE, message = FALSE, warning = FALSE, error = FALSE}
#JArred
listings <- read.csv("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\listings.csv")

listings_details <- read.csv("C:\\Users\\fatbo\\OneDrive\\Desktop\\Airbnb\\Airbnb\\listings_details.csv")

nhoods <- st_read("C:/Users/fatbo/OneDrive/Desktop/Airbnb/Airbnb/neighbourhoods.geojson")

joined <- left_join(listings, listings_details, by = "id", suffix=c("", ".y")) %>% select(-ends_with(".y"))

attraction_distance <- read.csv("C:\\Users\\fatbo\\OneDrive\\Documents\\GitHub\\Final_PPA\\Data\\Airbnb\\distance_attrac.csv")

income <- read.csv("C:\\Users\\fatbo\\OneDrive\\Documents\\GitHub\\Final_PPA\\Data\\Amsterdam_income.csv")

```